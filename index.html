<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- åŠ è½½Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com/4.0.0"></script>
  <title>PNGè½¬æ¢ç¥å™¨ by lensclear</title>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ–¼ï¸ PNGè½¬æ¢å·¥å…·</h1>
    
    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-6 text-center">
      <input type="file" id="upload" accept=".png" class="hidden" />
      <label for="upload" class="cursor-pointer">
        <div class="text-6xl mb-4">ğŸ“¤</div>
        <p class="text-gray-600">ç‚¹å‡»ä¸Šä¼ PNGæ–‡ä»¶</p>
      </label>
    </div>

    <!-- è®¾ç½®åŒºåŸŸ -->
    <div class="space-y-4 mb-6">
      <div>
        <label class="block text-gray-700 mb-2">è¾“å‡ºæ ¼å¼</label>
        <select id="format" class="w-full p-2 border rounded-lg">
          <option value="avif">AVIFï¼ˆè¶…å°ä½“ç§¯ï¼‰</option>
          <option value="webp">WebPï¼ˆå…¼å®¹æ€§å¥½ï¼‰</option>
        </select>
      </div>
      
      <div>
        <label class="block text-gray-700 mb-2">è´¨é‡ç­‰çº§</label>
        <input type="range" id="quality" min="1" max="100" value="80" 
               class="w-full bg-gray-200 rounded-lg">
      </div>
    </div>

    <!-- è½¬æ¢æŒ‰é’® -->
    <button onclick="convert()" 
            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition">
      å¼€å§‹è½¬æ¢
    </button>

    <!-- ç»“æœå±•ç¤º -->
    <div id="output" class="mt-6 hidden">
      <div class="bg-green-100 p-4 rounded-lg">
        <p class="text-green-700">âœ… è½¬æ¢æˆåŠŸï¼</p>
        <a id="downloadLink" class="text-blue-500 underline mt-2 inline-block">ç‚¹å‡»ä¸‹è½½</a>
      </div>
    </div>
  </div>

  <!-- è½¬æ¢è„šæœ¬ -->
  <script>
    // async function loadCodec(format) {
  const cdnURL = "https://esm.sh/@squoosh/";
  const { default: codec } = await import(`${cdnURL}${format === 'avif' ? 'avif-enc' : 'webp-enc'}`);
  return codec;
}

async function convert() {
  const file = document.getElementById('upload').files[0];
  const format = document.getElementById('format').value;
  const quality = document.getElementById('quality').value;

  // åŠ è½½ç¼–è§£ç å™¨
  const codec = await loadCodec(format);

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const outputDiv = document.getElementById('output');
  outputDiv.classList.add('hidden');

  // è¯»å–æ–‡ä»¶
  const reader = new FileReader();
  reader.onload = async (e) => {
    const imageData = new Uint8Array(e.target.result);

    // ä½¿ç”¨Web Workerå¤„ç†
    const worker = new Worker(new URL('worker.js', import.meta.url));
    
    worker.postMessage({
      imageData,
      format,
      options: { 
        quality: parseInt(quality),
        chromaSubsampling: '4:2:0'
      }
    });

    worker.onmessage = async ({ data }) => {
      const blob = new Blob([data], { type: `image/${format}` });
      const url = URL.createObjectURL(blob);
      
      // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
      const downloadLink = document.getElementById('downloadLink');
      downloadLink.href = url;
      downloadLink.download = `converted.${format}`;
      outputDiv.classList.remove('hidden');
    };
  };
  reader.readAsArrayBuffer(file);
}
  </script>
</body>
</html>